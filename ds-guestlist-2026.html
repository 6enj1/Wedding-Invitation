<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D &amp; S â€” Guest List</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --black:      #111111;
      --dark:       #1A1A2E;
      --dark2:      #161625;
      --gold:       #C9A84C;
      --gold-light: #E8D48B;
      --crystal:    #F0EDE3;
      --white:      #FFFFFF;
      --muted:      #777;
      --green:      #4caf6e;
      --red:        #e05c5c;
      --border:     rgba(255,255,255,0.07);
      --gold-border: rgba(201,168,76,0.18);
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--black);
      color: var(--white);
      min-height: 100vh;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOGIN
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 1.5rem;
      padding: 2rem;
    }
    .login-monogram {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      color: var(--gold);
      letter-spacing: 0.08em;
    }
    .login-sub { color: var(--muted); font-size: 0.8rem; letter-spacing: 0.05em; }
    #login-form {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      width: 100%;
      max-width: 320px;
    }
    #login-form input {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      color: var(--white);
      font-family: inherit;
      font-size: 0.9rem;
      padding: 0.8rem 1rem;
      outline: none;
      transition: border-color 0.2s;
      text-align: center;
    }
    #login-form input:focus { border-color: var(--gold); }
    #login-btn {
      background: var(--gold);
      border: none;
      border-radius: 8px;
      color: #111;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      padding: 0.85rem;
      text-transform: uppercase;
      transition: background 0.2s;
    }
    #login-btn:hover { background: var(--gold-light); }
    #login-error { color: var(--red); font-size: 0.78rem; text-align: center; display: none; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #dashboard { display: none; }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--dark);
      border-bottom: 1px solid var(--gold-border);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .header-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      color: var(--gold);
      line-height: 1.2;
    }
    .header-title small {
      display: block;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.68rem;
      color: var(--muted);
      font-weight: 400;
      margin-top: 2px;
      letter-spacing: 0.03em;
    }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0; }
    .btn {
      background: none;
      border: 1px solid var(--gold-border);
      border-radius: 6px;
      color: var(--gold);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      padding: 0.45rem 0.8rem;
      text-transform: uppercase;
      transition: background 0.2s, color 0.2s;
      white-space: nowrap;
    }
    .btn:hover { background: var(--gold); color: #111; }
    .btn-icon { padding: 0.45rem 0.6rem; font-size: 0.9rem; letter-spacing: 0; }
    .btn-logout { border-color: #2a2a2a; color: var(--muted); }
    .btn-logout:hover { background: #222; color: var(--white); border-color: #444; }

    /* â”€â”€ Main â”€â”€ */
    main { padding: 1.25rem; max-width: 1200px; margin: 0 auto; }

    /* â”€â”€ Stats â”€â”€ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--dark);
      border: 1px solid var(--gold-border);
      border-radius: 10px;
      padding: 1rem 1.1rem;
    }
    .stat-label {
      color: var(--muted);
      font-size: 0.62rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 0.4rem;
    }
    .stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      color: var(--gold);
      line-height: 1;
    }
    .stat-value.green { color: var(--green); }
    .stat-value.red   { color: var(--red); }

    /* â”€â”€ Filters â”€â”€ */
    .filters {
      display: flex;
      gap: 0.6rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-wrap { position: relative; flex: 1; min-width: 180px; }
    .search-wrap svg {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
      pointer-events: none;
    }
    .search-input {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      color: var(--white);
      font-family: inherit;
      font-size: 0.83rem;
      padding: 0.55rem 0.9rem 0.55rem 2.2rem;
      outline: none;
      width: 100%;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--gold); }
    .filter-pills { display: flex; gap: 0.4rem; }
    .filter-btn {
      background: none;
      border: 1px solid #2a2a2a;
      border-radius: 20px;
      color: var(--muted);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.72rem;
      font-weight: 500;
      padding: 0.4rem 0.9rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .filter-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }
    .filter-btn:hover  { border-color: var(--gold); color: var(--gold); }

    /* â”€â”€ Guest count label â”€â”€ */
    .list-meta {
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 0.85rem;
      padding-left: 2px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESKTOP TABLE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .table-wrap {
      background: var(--dark);
      border: 1px solid var(--gold-border);
      border-radius: 12px;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.81rem; }
    thead { background: rgba(201,168,76,0.06); }
    th {
      color: var(--gold);
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      padding: 0.85rem 1rem;
      text-align: left;
      text-transform: uppercase;
      white-space: nowrap;
      border-bottom: 1px solid var(--gold-border);
    }
    td {
      border-top: 1px solid var(--border);
      color: #ccc;
      padding: 0.85rem 1rem;
      vertical-align: middle;
    }
    tr:hover td { background: rgba(255,255,255,0.02); }
    .col-num   { color: var(--muted); font-size: 0.72rem; width: 36px; }
    .col-name  { font-weight: 500; color: var(--white); }
    .col-email { color: var(--muted); font-size: 0.75rem; }
    .col-slim  { white-space: nowrap; }
    .col-text  { max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--muted); font-size: 0.75rem; }
    .col-ts    { color: var(--muted); font-size: 0.7rem; white-space: nowrap; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE CARDS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cards-wrap { display: none; }
    .guest-card {
      background: var(--dark);
      border: 1px solid var(--gold-border);
      border-radius: 12px;
      padding: 1rem 1.1rem;
      margin-bottom: 0.75rem;
    }
    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .card-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--white);
      line-height: 1.3;
    }
    .card-email {
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 2px;
    }
    .card-rows { display: flex; flex-direction: column; gap: 0.45rem; }
    .card-row {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      font-size: 0.78rem;
    }
    .card-row-label {
      color: var(--muted);
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      min-width: 70px;
      flex-shrink: 0;
    }
    .card-row-value { color: #ccc; }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.85rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }
    .card-ts { font-size: 0.65rem; color: var(--muted); }

    /* â”€â”€ Shared badges â”€â”€ */
    .badge {
      border-radius: 20px;
      display: inline-block;
      font-size: 0.68rem;
      font-weight: 600;
      padding: 0.18rem 0.65rem;
      white-space: nowrap;
    }
    .badge-yes { background: rgba(76,175,110,0.12); color: var(--green); border: 1px solid rgba(76,175,110,0.2); }
    .badge-no  { background: rgba(224,92,92,0.12);  color: var(--red);   border: 1px solid rgba(224,92,92,0.2); }
    .guest-pill {
      background: rgba(201,168,76,0.1);
      border: 1px solid rgba(201,168,76,0.2);
      border-radius: 12px;
      color: var(--gold);
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.15rem 0.55rem;
    }

    /* â”€â”€ Remove button â”€â”€ */
    .btn-delete {
      background: none;
      border: 1px solid rgba(224,92,92,0.25);
      border-radius: 6px;
      color: var(--red);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.7rem;
      padding: 0.3rem 0.65rem;
      transition: background 0.2s, border-color 0.2s;
      opacity: 0.55;
      white-space: nowrap;
    }
    .btn-delete:hover, .card-footer .btn-delete { opacity: 1; }
    tr:hover .btn-delete { opacity: 1; border-color: var(--red); }

    /* â”€â”€ Empty / spinner â”€â”€ */
    .empty-state {
      color: var(--muted);
      font-size: 0.83rem;
      padding: 3rem;
      text-align: center;
      line-height: 1.8;
    }
    .spinner {
      border: 2px solid rgba(201,168,76,0.15);
      border-top-color: var(--gold);
      border-radius: 50%;
      width: 26px; height: 26px;
      animation: spin 0.7s linear infinite;
      margin: 3rem auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIRM MODAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .confirm-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }
    .confirm-overlay.open { display: flex; }
    .confirm-box {
      background: #1a1a2a;
      border: 1px solid var(--gold-border);
      border-radius: 14px;
      max-width: 360px;
      width: 100%;
      padding: 2rem 1.75rem;
      text-align: center;
    }
    .confirm-icon { font-size: 2rem; margin-bottom: 0.75rem; }
    .confirm-box h3 {
      font-family: 'Playfair Display', serif;
      color: var(--white);
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .confirm-box p {
      color: var(--muted);
      font-size: 0.8rem;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    .confirm-box strong { color: var(--white); }
    .confirm-actions { display: flex; gap: 0.75rem; }
    .confirm-cancel {
      flex: 1;
      background: none;
      border: 1px solid #333;
      border-radius: 8px;
      color: var(--muted);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.82rem;
      padding: 0.7rem;
      transition: all 0.2s;
    }
    .confirm-cancel:hover { border-color: #555; color: var(--white); }
    .confirm-remove {
      flex: 1;
      background: var(--red);
      border: none;
      border-radius: 8px;
      color: var(--white);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 600;
      padding: 0.7rem;
      transition: opacity 0.2s;
    }
    .confirm-remove:hover { opacity: 0.85; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 700px) {
      header { padding: 0.85rem 1rem; }
      main   { padding: 1rem; }

      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.6rem; margin-bottom: 1.25rem; }
      .stat-value { font-size: 1.7rem; }

      .search-input { font-size: 0.85rem; }

      /* Switch table â†’ cards on mobile */
      .table-wrap  { display: none; }
      .cards-wrap  { display: block; }

      .btn span { display: none; }
      .btn-icon-label::before { content: attr(data-icon); }
    }
  </style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div id="login-screen">
  <div class="login-monogram">D &amp; S</div>
  <div class="login-sub">26 December 2026 Â· Guest List</div>
  <form id="login-form">
    <input type="password" id="pwd-input" placeholder="Enter password" autocomplete="current-password" />
    <button type="submit" id="login-btn">Enter</button>
    <p id="login-error">Incorrect password.</p>
  </form>
</div>

<!-- â”€â”€ CONFIRM MODAL â”€â”€ -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-icon">ğŸ—‘ï¸</div>
    <h3>Remove Guest</h3>
    <p>Remove <strong id="confirm-name"></strong> from the guest list?<br>This cannot be undone.</p>
    <div class="confirm-actions">
      <button class="confirm-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-remove" id="confirm-remove-btn">Remove</button>
    </div>
  </div>
</div>

<!-- â”€â”€ DASHBOARD â”€â”€ -->
<div id="dashboard">
  <header>
    <div class="header-title">
      Guest List
      <small>Dorcas &amp; Samuel Â· 26 Dec 2026</small>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="exportCSV()" title="Export CSV">â¬‡ <span>Export</span></button>
      <button class="btn btn-icon" onclick="loadData()" title="Refresh">â†»</button>
      <button class="btn btn-logout" onclick="logout()">Exit</button>
    </div>
  </header>

  <main>
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">RSVPs</div>
        <div class="stat-value" id="stat-total">â€”</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Attending</div>
        <div class="stat-value green" id="stat-attending">â€”</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Declined</div>
        <div class="stat-value red" id="stat-not">â€”</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Guests</div>
        <div class="stat-value" id="stat-guests">â€”</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="search-wrap">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" type="search" id="search" placeholder="Search name or emailâ€¦" oninput="renderAll()" />
      </div>
      <div class="filter-pills">
        <button class="filter-btn active" data-filter="all"       onclick="setFilter(this)">All</button>
        <button class="filter-btn"        data-filter="attending" onclick="setFilter(this)">Attending</button>
        <button class="filter-btn"        data-filter="not"       onclick="setFilter(this)">Declined</button>
      </div>
    </div>

    <div class="list-meta" id="list-meta"></div>

    <!-- Desktop table -->
    <div class="table-wrap" id="table-wrap">
      <div class="spinner"></div>
    </div>

    <!-- Mobile cards -->
    <div class="cards-wrap" id="cards-wrap">
      <div class="spinner"></div>
    </div>
  </main>
</div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyNyUmcBi6cX-A7PFF2szdIzUcHphUoUacffpRPiLKR7LnrKLv5zPXLdpy4PZ7lkC-A/exec';
  const ADMIN_KEY       = 'dorcas-samuel-2026';
  const ADMIN_PASSWORD  = 'dorcas2026';

  let allRows      = [];
  let allRowNums   = [];
  let activeFilter = 'all';

  /* â”€â”€ LOGIN â”€â”€ */
  document.getElementById('login-form').addEventListener('submit', e => {
    e.preventDefault();
    if (document.getElementById('pwd-input').value === ADMIN_PASSWORD) {
      sessionStorage.setItem('admin_auth', '1');
      showDashboard();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  });

  function showDashboard() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('dashboard').style.display    = 'block';
    loadData();
  }

  function logout() {
    sessionStorage.removeItem('admin_auth');
    location.reload();
  }

  if (sessionStorage.getItem('admin_auth') === '1') showDashboard();

  /* â”€â”€ LOAD DATA (JSONP) â”€â”€ */
  function loadData() {
    document.getElementById('table-wrap').innerHTML  = '<div class="spinner"></div>';
    document.getElementById('cards-wrap').innerHTML  = '<div class="spinner"></div>';
    document.getElementById('list-meta').textContent = '';

    const cbName = 'rsvpCb_' + Date.now();
    const script = document.createElement('script');
    script.src   = `${APPS_SCRIPT_URL}?key=${ADMIN_KEY}&callback=${cbName}&t=${Date.now()}`;

    const timer = setTimeout(() => {
      cleanup();
      setError('Request timed out. Check your Apps Script URL.');
    }, 12000);

    function cleanup() {
      clearTimeout(timer);
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = json => {
      cleanup();
      if (!json.success) { setError(json.error || 'Failed to load'); return; }
      allRows    = json.data.slice(1);
      allRowNums = allRows.map((_, i) => i + 2);
      updateStats();
      renderAll();
    };

    script.onerror = () => { cleanup(); setError('Could not reach Apps Script. Check the URL.'); };
    document.head.appendChild(script);
  }

  function setError(msg) {
    const html = `<div class="empty-state">âš ï¸ ${msg}</div>`;
    document.getElementById('table-wrap').innerHTML = html;
    document.getElementById('cards-wrap').innerHTML = html;
  }

  /* â”€â”€ STATS â”€â”€ */
  function updateStats() {
    const att   = allRows.filter(r => r[3] === 'Attending');
    const noAtt = allRows.filter(r => r[3] === 'Not Attending');
    const total = att.reduce((s, r) => s + (Number(r[4]) || 0), 0);

    document.getElementById('stat-total').textContent     = allRows.length;
    document.getElementById('stat-attending').textContent = att.length;
    document.getElementById('stat-not').textContent       = noAtt.length;
    document.getElementById('stat-guests').textContent    = total;
  }

  /* â”€â”€ FILTER â”€â”€ */
  function setFilter(btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    renderAll();
  }

  function getFiltered() {
    const q = document.getElementById('search').value.toLowerCase();
    return allRows
      .map((r, i) => ({ r, sheetRow: allRowNums[i] }))
      .filter(({ r }) => {
        const matchSearch = !q || r[1].toString().toLowerCase().includes(q) || r[2].toString().toLowerCase().includes(q);
        const att = r[3] === 'Attending';
        const matchFilter = activeFilter === 'all' ? true : activeFilter === 'attending' ? att : !att;
        return matchSearch && matchFilter;
      });
  }

  /* â”€â”€ RENDER BOTH TABLE + CARDS â”€â”€ */
  function renderAll() {
    const pairs = getFiltered();

    document.getElementById('list-meta').textContent =
      pairs.length === 0 ? '' : `${pairs.length} guest${pairs.length !== 1 ? 's' : ''}`;

    if (!pairs.length) {
      const html = '<div class="empty-state">No guests found.</div>';
      document.getElementById('table-wrap').innerHTML = html;
      document.getElementById('cards-wrap').innerHTML = html;
      return;
    }

    renderTable(pairs);
    renderCards(pairs);
  }

  /* â”€â”€ DESKTOP TABLE â”€â”€ */
  function renderTable(pairs) {
    document.getElementById('table-wrap').innerHTML = `
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Guests</th>
            <th>Dietary</th>
            <th>Message</th>
            <th>Submitted</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${pairs.map(({ r, sheetRow }, i) => `
            <tr>
              <td class="col-num">${i + 1}</td>
              <td class="col-name">${esc(r[1])}</td>
              <td class="col-email">${esc(r[2]) || 'â€”'}</td>
              <td class="col-slim">${r[3] === 'Attending'
                ? '<span class="badge badge-yes">âœ“ Attending</span>'
                : '<span class="badge badge-no">âœ— Declined</span>'}</td>
              <td class="col-slim">${r[3] === 'Attending'
                ? `<span class="guest-pill">${r[4] || 1}</span>` : 'â€”'}</td>
              <td class="col-text" title="${esc([r[5],r[6]].filter(Boolean).join(', '))}">${esc([r[5],r[6]].filter(Boolean).join(', ')) || 'â€”'}</td>
              <td class="col-text" title="${esc(r[7])}">${esc(r[7]) || 'â€”'}</td>
              <td class="col-ts">${esc(r[0])}</td>
              <td><button class="btn-delete" onclick="deleteGuest(${sheetRow},'${esc(r[1])}')">âœ• Remove</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  }

  /* â”€â”€ MOBILE CARDS â”€â”€ */
  function renderCards(pairs) {
    document.getElementById('cards-wrap').innerHTML = pairs.map(({ r, sheetRow }, i) => {
      const attending = r[3] === 'Attending';
      const dietary   = [r[5], r[6]].filter(Boolean).join(', ');
      return `
        <div class="guest-card">
          <div class="card-top">
            <div>
              <div class="card-name">${esc(r[1])}</div>
              ${r[2] ? `<div class="card-email">${esc(r[2])}</div>` : ''}
            </div>
            ${attending
              ? '<span class="badge badge-yes">âœ“ Attending</span>'
              : '<span class="badge badge-no">âœ— Declined</span>'}
          </div>
          <div class="card-rows">
            ${attending ? `
              <div class="card-row">
                <span class="card-row-label">Guests</span>
                <span class="card-row-value"><span class="guest-pill">${r[4] || 1}</span></span>
              </div>` : ''}
            ${dietary ? `
              <div class="card-row">
                <span class="card-row-label">Dietary</span>
                <span class="card-row-value">${esc(dietary)}</span>
              </div>` : ''}
            ${r[7] ? `
              <div class="card-row">
                <span class="card-row-label">Message</span>
                <span class="card-row-value">${esc(r[7])}</span>
              </div>` : ''}
          </div>
          <div class="card-footer">
            <span class="card-ts">${esc(r[0])}</span>
            <button class="btn-delete" onclick="deleteGuest(${sheetRow},'${esc(r[1])}')">âœ• Remove</button>
          </div>
        </div>`;
    }).join('');
  }

  /* â”€â”€ DELETE â”€â”€ */
  let pendingDeleteRow = null;

  function deleteGuest(sheetRow, name) {
    pendingDeleteRow = sheetRow;
    document.getElementById('confirm-name').textContent = name;
    document.getElementById('confirm-overlay').classList.add('open');
  }

  function closeConfirm() {
    document.getElementById('confirm-overlay').classList.remove('open');
    pendingDeleteRow = null;
  }

  document.getElementById('confirm-remove-btn').addEventListener('click', () => {
    if (!pendingDeleteRow) return;
    const row = pendingDeleteRow;
    closeConfirm();

    const cbName = 'delCb_' + Date.now();
    const script = document.createElement('script');
    script.src   = `${APPS_SCRIPT_URL}?key=${ADMIN_KEY}&action=delete&row=${row}&callback=${cbName}&t=${Date.now()}`;

    window[cbName] = json => {
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
      if (json.success) loadData();
    };

    document.head.appendChild(script);
  });

  document.getElementById('confirm-overlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeConfirm();
  });

  /* â”€â”€ EXPORT CSV â”€â”€ */
  function exportCSV() {
    const headers = ['Timestamp','Name','Email','Attending','Guests','Dietary','Other','Message'];
    const lines   = [headers, ...allRows].map(r =>
      r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')
    );
    const a = Object.assign(document.createElement('a'), {
      href: URL.createObjectURL(new Blob([lines.join('\n')], { type: 'text/csv' })),
      download: 'dorcas-samuel-rsvp.csv',
    });
    a.click();
  }

  function esc(s) {
    return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/'/g,'&#39;');
  }
</script>
</body>
</html>
